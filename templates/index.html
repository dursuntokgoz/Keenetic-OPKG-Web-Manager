<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keenetic App Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-950 text-slate-100 p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">
                    Keenetic App Store
                </h1>
                <p class="text-slate-500 text-sm mt-1 uppercase tracking-widest font-bold">OPKG Web Interface</p>
            </div>
            <button onclick="location.reload()" class="bg-slate-800 hover:bg-slate-700 px-6 py-2 rounded-full transition-all border border-slate-700 flex items-center gap-2">
                <i class="fas fa-sync-alt"></i> Listeyi Yenile
            </button>
        </div>

        <div class="relative mb-8 group">
            <i class="fas fa-search absolute left-5 top-5 text-slate-500 group-focus-within:text-cyan-400 transition"></i>
            <input type="text" id="search" onkeyup="filterTable()" placeholder="Paketlerde ara (örn: adguard, transmission...)" 
                   class="w-full p-5 pl-14 bg-slate-900 border border-slate-800 rounded-2xl focus:ring-2 focus:ring-cyan-500/50 outline-none transition-all shadow-2xl shadow-cyan-900/10">
        </div>

        <div class="bg-slate-900 rounded-3xl shadow-2xl overflow-hidden border border-slate-800">
            <div class="max-h-[600px] overflow-y-auto custom-scrollbar">
                <table class="w-full text-left border-collapse" id="pkgTable">
                    <thead class="bg-slate-800/80 backdrop-blur-xl sticky top-0 z-10">
                        <tr>
                            <th class="p-5 text-xs font-black text-slate-500 uppercase tracking-widest">Durum</th>
                            <th class="p-5 text-xs font-black text-slate-500 uppercase tracking-widest">Paket Adı</th>
                            <th class="p-5 text-xs font-black text-slate-500 uppercase tracking-widest">Açıklama</th>
                            <th class="p-5 text-center text-xs font-black text-slate-500 uppercase tracking-widest">Eylem</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-800/50">
                        {% for pkg in packages %}
                        <tr class="hover:bg-slate-800/40 transition group">
                            <td class="p-5">
                                {% if pkg.installed %}
                                <span class="bg-cyan-500/10 text-cyan-400 text-[10px] font-black px-3 py-1 rounded-md border border-cyan-500/20 shadow-lg shadow-cyan-900/20">YÜKLÜ</span>
                                {% else %}
                                <span class="bg-slate-800 text-slate-500 text-[10px] font-black px-3 py-1 rounded-md border border-slate-700">DEPO</span>
                                {% endif %}
                            </td>
                            <td class="p-5">
                                <div class="font-bold text-slate-200 group-hover:text-cyan-400 transition">{{ pkg.name }}</div>
                                <div class="text-[10px] text-slate-600 font-mono mt-1">{{ pkg.version }}</div>
                            </td>
                            <td class="p-5 text-sm text-slate-400 leading-relaxed max-w-md">
                                {{ pkg.desc[:140] }}{% if pkg.desc|length > 140 %}...{% endif %}
                            </td>
                            <td class="p-5 text-center">
                                {% if pkg.installed %}
                                <button onclick="runOpkg('{{ pkg.name }}', 'remove')" class="bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white px-5 py-2 rounded-xl text-xs font-black transition-all border border-red-500/20 uppercase tracking-tighter">Kaldır</button>
                                {% else %}
                                <button onclick="runOpkg('{{ pkg.name }}', 'install')" class="bg-cyan-600 hover:bg-cyan-500 text-white px-5 py-2 rounded-xl text-xs font-black shadow-lg shadow-cyan-900/40 transition-all uppercase tracking-tighter">Yükle</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mt-10 bg-black rounded-3xl p-6 border border-slate-800 shadow-2xl shadow-cyan-900/5">
            <div class="flex items-center gap-3 mb-4 text-slate-500 text-[10px] font-black uppercase tracking-[0.2em]">
                <span class="w-3 h-3 rounded-full bg-cyan-500 animate-pulse shadow-[0_0_10px_rgba(6,182,212,0.8)]"></span> Console Logs
            </div>
            <div id="terminal" class="font-mono text-[12px] text-cyan-400 h-40 overflow-y-auto leading-relaxed">
                > Sistem hazır. Lütfen bir işlem seçin...
            </div>
        </div>
    </div>

    <script>
        // Arama Filtreleme
        function filterTable() {
            let input = document.getElementById("search").value.toUpperCase();
            let rows = document.getElementById("pkgTable").getElementsByTagName("tr");
            for (let i = 1; i < rows.length; i++) {
                let text = rows[i].textContent.toUpperCase();
                rows[i].style.display = text.includes(input) ? "" : "none";
            }
        }

        // OPKG Komut Çalıştırma
        async function runOpkg(name, action) {
            if (!confirm(`${name} paketini ${action === 'install' ? 'kurmak' : 'kaldırmak'} istediğinize emin misiniz?`)) return;
            
            const term = document.getElementById('terminal');
            term.innerHTML += `<br><span class="text-white font-bold">> [SİSTEM] opkg ${action} ${name} başlatıldı...</span>`;
            
            try {
                const response = await fetch('/action', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name: name, action: action})
                });
                const data = await response.json();
                term.innerHTML += `<br><span class="text-slate-400">${data.output.replace(/\n/g, '<br>')}</span>`;
                term.scrollTop = term.scrollHeight;
                
                // Başarılı işlem sonrası 2.5 saniye sonra yenile
                setTimeout(() => { location.reload(); }, 2500);
            } catch (err) {
                term.innerHTML += `<br><span class="text-red-500">> [HATA] ${err}</span>`;
            }
        }
    </script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #334155; }
    </style>
</body>
</html>
